<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grand-Family - 山田家 親族名簿</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="/src/styles.css" rel="stylesheet">
</head>

<body x-data="mainApp" x-init="init()">

  <!-- ======================================== -->
  <!-- ログイン画面（未認証時のみ表示） -->
  <!-- ======================================== -->
  <div x-show="!isAuthenticated" x-cloak class="login-screen">
    <div class="login-card">
      <div class="login-header">
        <img src="/竹の無料素材2.svg" alt="竹" class="login-icon">
        <h1 class="login-title">デジタルまごまご会名簿</h1>
      </div>

      <form @submit.prevent="onLoginSuccess()" class="login-form">
        <div class="login-input-group">
          <label class="login-label" for="loginId">
            <i class="bi bi-person"></i> ID
          </label>
          <input type="text" id="loginId" class="login-input" x-model="loginId" placeholder="IDを入力"
            autocomplete="username">
        </div>

        <div class="login-input-group">
          <label class="login-label" for="loginPassword">
            <i class="bi bi-calendar3"></i> 生年月日
          </label>
          <div class="password-input-wrapper">
            <input :type="showPassword ? 'text' : 'password'" id="loginPassword" class="login-input"
              x-model="loginPassword" placeholder="8桁（例: 19560423）" inputmode="numeric" maxlength="8"
              autocomplete="current-password"
              @input="loginPassword = loginPassword.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/[^0-9]/g, '')">
            <button type="button" class="password-toggle-btn" @click="showPassword = !showPassword" tabindex="-1">
              <i class="bi" :class="showPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
            </button>
          </div>
        </div>

        <div x-show="loginError" x-cloak class="login-error">
          <i class="bi bi-exclamation-circle"></i>
          <span x-text="loginError"></span>
        </div>

        <button type="submit" class="login-btn" :disabled="isLoggingIn">
          <span x-show="!isLoggingIn">
            <i class="bi bi-box-arrow-in-right"></i> ログイン
          </span>
          <span x-show="isLoggingIn">
            <i class="bi bi-hourglass-split"></i> 確認中...
          </span>
        </button>
      </form>

      <div class="login-footer">
        <small>生年月日は名簿に登録されている方のみ有効です</small>
      </div>
    </div>
  </div>

  <!-- ======================================== -->
  <!-- メインコンテンツ（認証後のみ表示） -->
  <!-- ======================================== -->
  <div x-show="isAuthenticated" x-cloak>

    <!-- ナビゲーションバー -->
    <nav class="navbar">
      <div class="container">
        <a class="navbar-brand" href="#">
          <img src="/竹の無料素材2.svg" alt="竹" class="navbar-icon"> デジタルまごまご会
        </a>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-dark btn-sm" data-bs-toggle="modal" data-bs-target="#addMemberModal">
            <i class="bi bi-plus-lg"></i> 新規登録
          </button>
          <button class="btn btn-outline-secondary btn-sm" @click="logout()">
            <i class="bi bi-box-arrow-right"></i>
          </button>
        </div>
      </div>
    </nav>

    <!-- メインコンテンツ -->
    <div class="container mt-4">
      <!-- スティッキー・タブナビゲーション（ピルスタイル） -->
      <div class="sticky-nav-container">
        <ul class="nav nav-pills-custom justify-content-center mb-3" role="tablist">
          <li class="nav-item">
            <button class="nav-pill" :class="{ active: currentView === 'magomago' }" @click="currentView = 'magomago'">
              <i class="bi bi-people"></i> まごまご会
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-pill" :class="{ active: currentView === 'tengoku' }" @click="currentView = 'tengoku'">
              <i class="bi bi-cloud"></i> 天国会
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-pill" :class="{ active: currentView === 'tree' }" @click="currentView = 'tree'">
              <i class="bi bi-diagram-3"></i> 家系図
            </button>
          </li>
        </ul>
      </div>

      <!-- まごまご会名簿（全員） -->
      <div x-show="currentView === 'magomago'" x-data="{ isSearchExpanded: false }">

        <!-- コントロール・ハブ：枝番フィルタ + 検索 -->
        <div class="control-hub d-flex align-items-center mb-4">

          <!-- 左：枝番フィルター（横スクロールチップス） -->
          <div class="branch-chips-container flex-grow-1 overflow-auto">
            <div class="branch-chips d-flex gap-2 py-2">
              <button class="branch-chip" :class="selectedBranchId === null ? 'active' : ''"
                @click="selectedBranchId = null">
                <i class="bi bi-check2" x-show="selectedBranchId === null"></i>
                全て
              </button>
              <template x-for="i in 9" :key="i">
                <button class="branch-chip" :class="selectedBranchId === i ? 'active' : ''"
                  @click="selectedBranchId = i">
                  <i class="bi bi-check2" x-show="selectedBranchId === i"></i>
                  <span x-text="branchLabels[i]"></span>
                </button>
              </template>
            </div>
          </div>

          <!-- 右：検索トリガー -->
          <div class="ms-3 flex-shrink-0">
            <button type="button" class="search-toggle-btn"
              @click="isSearchExpanded = !isSearchExpanded; if(isSearchExpanded) $nextTick(() => $refs.searchInput.focus()); else searchQuery = '';">
              <i class="bi" :class="isSearchExpanded ? 'bi-x-lg' : 'bi-search'"></i>
            </button>
          </div>
        </div>

        <!-- 展開式検索バー -->
        <div class="search-bar-container mb-4" :class="isSearchExpanded ? 'expanded' : ''">
          <div class="search-bar-inner">
            <i class="bi bi-search text-muted"></i>
            <input type="text" class="search-input" placeholder="名前で検索..." x-model="searchQuery" x-ref="searchInput"
              @keydown.escape="isSearchExpanded = false; searchQuery = '';">
            <!-- クリアボタン -->
            <button type="button" class="search-clear-btn" x-show="searchQuery.length > 0"
              @click="searchQuery = ''; $refs.searchInput.focus();">
              <i class="bi bi-x-circle-fill"></i>
            </button>
          </div>
        </div>

        <!-- 選択中の枝番のメンバーリスト -->
        <template
          x-for="branch in membersByBranch.filter(b => selectedBranchId === null || b.branchId === selectedBranchId)"
          :key="branch.branchId">
          <div class="card branch-card mb-4">
            <!-- 枝番ヘッダー（カードヘッダー） -->
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="bi bi-signpost-split text-primary"></i>
                <span x-text="branch.branchName"></span>
              </h5>
              <span class="badge bg-primary" x-text="`${branch.members.length}名`"></span>
            </div>

            <!-- メンバーリスト（カードボディ） -->
            <div class="list-group list-group-flush">
              <template x-for="member in branch.members" :key="member.id">
                <div class="list-group-item list-group-item-action"
                  :class="{ 'bg-light': member.registry === 'tengoku' }" style="cursor: pointer;"
                  @click="openViewMember(member)">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <!-- 名前と天国会員バッジ -->
                      <div class="d-flex align-items-center gap-2 mb-1">
                        <strong x-text="`${member.lastName} ${member.firstName}`"></strong>
                        <span class="badge ms-1" x-show="member.registry === 'tengoku'"
                          style="background-color: #4a5d23; color: white;">
                          <i class="bi bi-cloud"></i> 天国会員
                        </span>
                      </div>
                      <!-- 詳細情報 -->
                      <div class="small text-muted">
                        <span x-text="`第${member.generation}世代`"></span>
                        <template x-if="member.birthDate">
                          <span>
                            ｜ <i class="bi bi-cake2"></i>
                            <span x-text="member.birthDate"></span>
                            (<span
                              x-text="calculateAge(member.birthDate, member.registry === 'tengoku' ? member.passedAt : null)"></span>歳<span
                              x-show="member.registry === 'tengoku'">で永眠</span>)
                          </span>
                        </template>
                      </div>
                      <div class="small text-muted mt-1" x-show="member.phone || member.address">
                        <template x-if="member.phone">
                          <span>
                            <i class="bi bi-telephone"></i>
                            <a :href="`tel:${member.phone}`" class="text-decoration-none" @click.stop
                              x-text="member.phone"></a>
                          </span>
                        </template>
                        <template x-if="member.address">
                          <span :class="{ 'ms-2': member.phone }">
                            <i class="bi bi-geo-alt"></i>
                            <span x-text="member.address"></span>
                          </span>
                        </template>
                      </div>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm" @click.stop="openEditMember(member)">
                      <i class="bi bi-pencil"></i>
                    </button>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>

        <div class="text-center text-muted py-4" x-show="membersByBranch.length === 0">
          メンバーがいません
        </div>
      </div>

      <!-- 天国会名簿（故人） -->
      <div x-show="currentView === 'tengoku'"
        x-data="{ isSearchExpanded: false, tengokuSearchQuery: '', selectedTengokuBranchId: null }">

        <!-- コントロール・ハブ：枝番フィルタ + 検索 -->
        <div class="control-hub d-flex align-items-center mb-4">

          <!-- 左：枝番フィルター（横スクロールチップス） -->
          <div class="branch-chips-container flex-grow-1 overflow-auto">
            <div class="branch-chips d-flex gap-2 py-2">
              <button class="branch-chip" :class="selectedTengokuBranchId === null ? 'active' : ''"
                @click="selectedTengokuBranchId = null">
                <i class="bi bi-check2" x-show="selectedTengokuBranchId === null"></i>
                全て
              </button>
              <template x-for="i in 9" :key="i">
                <button class="branch-chip" :class="selectedTengokuBranchId === i ? 'active' : ''"
                  @click="selectedTengokuBranchId = i">
                  <i class="bi bi-check2" x-show="selectedTengokuBranchId === i"></i>
                  <span x-text="branchLabels[i]"></span>
                </button>
              </template>
            </div>
          </div>

          <!-- 右：検索トリガー -->
          <div class="ms-3 flex-shrink-0">
            <button type="button" class="search-toggle-btn"
              @click="isSearchExpanded = !isSearchExpanded; if(isSearchExpanded) $nextTick(() => $refs.tengokuSearchInput.focus()); else tengokuSearchQuery = '';">
              <i class="bi" :class="isSearchExpanded ? 'bi-x-lg' : 'bi-search'"></i>
            </button>
          </div>
        </div>

        <!-- 展開式検索バー -->
        <div class="search-bar-container mb-4" :class="isSearchExpanded ? 'expanded' : ''">
          <div class="search-bar-inner">
            <i class="bi bi-search text-muted"></i>
            <input type="text" class="search-input" placeholder="名前で検索..." x-model="tengokuSearchQuery"
              x-ref="tengokuSearchInput" @keydown.escape="isSearchExpanded = false; tengokuSearchQuery = '';">
            <!-- クリアボタン -->
            <button type="button" class="search-clear-btn" x-show="tengokuSearchQuery.length > 0"
              @click="tengokuSearchQuery = ''; $refs.tengokuSearchInput.focus();">
              <i class="bi bi-x-circle-fill"></i>
            </button>
          </div>
        </div>

        <!-- 枝番ごとのカード -->
        <template
          x-for="branchId in [null, 1, 2, 3, 4, 5, 6, 7, 8, 9].filter(id => selectedTengokuBranchId === null || selectedTengokuBranchId === id)"
          :key="branchId ?? 'all'">
          <template
            x-if="tengokuMembers.filter(m => (branchId === null || m.branchId === branchId) && (tengokuSearchQuery === '' || `${m.lastName}${m.firstName}`.toLowerCase().includes(tengokuSearchQuery.toLowerCase()))).length > 0">
            <div class="card branch-card mb-4" x-show="branchId !== null">
              <!-- 枝番ヘッダー -->
              <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                  <i class="bi bi-signpost-split text-primary"></i>
                  <span x-text="branchLabels[branchId] || '始祖'"></span>
                </h5>
                <span class="badge bg-primary"
                  x-text="`${tengokuMembers.filter(m => m.branchId === branchId && (tengokuSearchQuery === '' || `${m.lastName}${m.firstName}`.toLowerCase().includes(tengokuSearchQuery.toLowerCase()))).length}名`"></span>
              </div>

              <!-- メンバーリスト -->
              <div class="list-group list-group-flush">
                <template
                  x-for="member in tengokuMembers.filter(m => m.branchId === branchId && (tengokuSearchQuery === '' || `${m.lastName}${m.firstName}`.toLowerCase().includes(tengokuSearchQuery.toLowerCase())))"
                  :key="member.id">
                  <div class="list-group-item list-group-item-action bg-light" style="cursor: pointer;"
                    @click="openViewMember(member)">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1">
                        <!-- 名前 -->
                        <div class="d-flex align-items-center gap-2 mb-1">
                          <strong x-text="`${member.lastName} ${member.firstName}`"></strong>
                        </div>
                        <!-- 詳細情報 -->
                        <div class="small text-muted">
                          <span x-text="`第${member.generation}世代`"></span>
                          <template x-if="member.passedAt">
                            <span>
                              ｜ <i class="bi bi-cloud"></i>
                              <span x-text="member.passedAt"></span>
                              (享年<span x-text="calculateAge(member.birthDate, member.passedAt)"></span>歳)
                            </span>
                          </template>
                        </div>
                      </div>
                      <button class="btn btn-outline-secondary btn-sm" @click.stop="openEditMember(member)">
                        <i class="bi bi-pencil"></i>
                      </button>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </template>
        </template>

        <div class="text-center text-muted py-4" x-show="tengokuMembers.length === 0">
          メンバーがいません
        </div>
      </div>

      <div x-show="currentView === 'tree'" x-init="$watch('currentView', v => { if (v === 'tree') initTree(); })"
        class="position-relative">

        <!-- 家系図コンテナ -->
        <div id="family-tree-container" class="family-tree-washi rounded" style="min-height: 500px; overflow: hidden;">
        </div>

        <!-- コントロール・ドック（右下フロート） -->
        <div class="control-dock">
          <button class="control-dock-btn" @click="resetZoom()" title="始祖へ戻る">
            <i class="bi bi-house-door"></i>
          </button>
          <button class="control-dock-btn" @click="fitToView()" title="全体を表示">
            <i class="bi bi-arrows-fullscreen"></i>
          </button>
          <div class="control-dock-divider"></div>
          <button class="control-dock-btn" @click="zoomIn()" title="拡大">
            <i class="bi bi-plus-lg"></i>
          </button>
          <button class="control-dock-btn" @click="zoomOut()" title="縮小">
            <i class="bi bi-dash-lg"></i>
          </button>
          <div class="control-dock-divider"></div>
          <button class="control-dock-btn" @click="toggleExpandAll()" title="全て展開/折りたたみ">
            <i class="bi bi-diagram-2"></i>
          </button>
        </div>

        <!-- バージョン情報 -->
        <div class="text-center text-muted mt-3" style="font-size: 0.75rem; opacity: 0.6;">
          <span id="appVersionDisplay"></span>
        </div>
      </div>
    </div>

    <!-- ======================================== -->
    <!-- 新規メンバー登録モーダル -->
    <!-- ======================================== -->
    <div class="modal fade" id="addMemberModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title"><i class="bi bi-person-plus"></i> 新規メンバー登録</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">

            <!-- 親選択 (インクリメンタル検索) -->
            <div class="card mb-3 border-primary">
              <div class="card-header bg-primary text-white">
                <i class="bi bi-arrow-up-circle"></i> 親（父または母）の選択
              </div>
              <div class="card-body">
                <!-- 選択済み表示（クリックで解除） -->
                <div x-show="newMember.parentId" class="alert alert-success mb-2" style="cursor: pointer;"
                  @click="clearParentSelection()">
                  <i class="bi bi-check-circle"></i>
                  <strong x-text="getParentDisplayName(newMember.parentId)"></strong>
                  <small class="text-muted ms-2">(クリックで変更)</small>
                </div>

                <!-- 検索入力 -->
                <div class="input-group" x-show="!newMember.parentId">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input type="text" class="form-control form-control-lg" x-model="parentSearchQuery"
                    placeholder="名前で検索..." @focus="showParentDropdown = true">
                </div>

                <!-- 候補リスト -->
                <div class="list-group mt-2" x-show="!newMember.parentId && parentSearchQuery.length > 0"
                  style="max-height: 200px; overflow-y: auto;">
                  <template x-for="member in filteredParentCandidates" :key="member.id">
                    <button type="button" class="list-group-item list-group-item-action" @click="selectParent(member)">
                      <div class="d-flex justify-content-between align-items-center">
                        <span x-text="`${member.lastName} ${member.firstName}`"></span>
                        <small class="text-muted"
                          x-text="`第${member.generation}世代 - ${branchLabels[member.branchId] || '始祖'}`"></small>
                      </div>
                    </button>
                  </template>
                  <div class="list-group-item text-muted text-center" x-show="filteredParentCandidates.length === 0">
                    候補が見つかりません
                  </div>
                </div>

                <!-- 全員表示（検索クエリが空の場合）-->
                <div class="mt-2" x-show="!newMember.parentId && parentSearchQuery.length === 0">
                  <small class="text-muted">
                    <i class="bi bi-info-circle"></i> 名前を入力して親を検索してください（登録人数: <span x-text="allMembers.length"></span>名）
                  </small>
                </div>
              </div>
            </div>

            <!-- 自動計算フィールド表示 -->
            <div class="row mb-3" x-show="newMember.parentId" x-transition>
              <div class="col-6">
                <label class="form-label"><i class="bi bi-layers"></i> 世代</label>
                <input type="text" class="form-control bg-light" :value="`第${newMember.generation}世代`" readonly
                  disabled>
              </div>
              <div class="col-6">
                <label class="form-label"><i class="bi bi-signpost-split"></i> 枝番</label>
                <!-- 始祖が親以外の場合: 読み取り専用 -->
                <input type="text" class="form-control bg-light" :value="branchLabels[newMember.branchId] || ''"
                  readonly disabled x-show="selectedParentGeneration > 1">
                <!-- 始祖が親の場合: 枝番を手動選択 -->
                <select class="form-select" x-model.number="newMember.branchId" x-show="selectedParentGeneration === 1"
                  :class="{ 'border-danger': selectedParentGeneration === 1 && !newMember.branchId }">
                  <option value="">枝番を選択 *</option>
                  <template x-for="i in 9" :key="i">
                    <option :value="i" x-text="branchLabels[i]"></option>
                  </template>
                </select>
                <small class="text-danger" x-show="selectedParentGeneration === 1 && !newMember.branchId">
                  <i class="bi bi-exclamation-triangle"></i> 枝番を選択してください（必須）
                </small>
              </div>
            </div>

            <hr>

            <!-- 基本情報 -->
            <h6 class="text-muted mb-3"><i class="bi bi-person"></i> 基本情報</h6>

            <div class="row mb-3">
              <div class="col-6">
                <label class="form-label">姓 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" x-model="newMember.lastName" placeholder="山田">
              </div>
              <div class="col-6">
                <label class="form-label">名 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" x-model="newMember.firstName" placeholder="太郎">
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">生年月日</label>
              <input type="date" class="form-control" x-model="newMember.birthDate">
            </div>

            <div class="mb-3">
              <label class="form-label">登録区分</label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="registry" id="registryMagomago" value="magomago"
                  x-model="newMember.registry">
                <label class="btn btn-outline-success" for="registryMagomago">
                  <i class="bi bi-emoji-smile"></i> まごまご会（生存）
                </label>

                <input type="radio" class="btn-check" name="registry" id="registryTengoku" value="tengoku"
                  x-model="newMember.registry">
                <label class="btn btn-outline-info" for="registryTengoku">
                  <i class="bi bi-cloud"></i> 天国会（故人）
                </label>
              </div>
            </div>

            <div class="mb-3" x-show="newMember.registry === 'tengoku'" x-transition>
              <label class="form-label">入会日</label>
              <input type="date" class="form-control" x-model="newMember.passedAt">
            </div>

            <hr>

            <!-- 配偶者同時登録 -->
            <div class="card mb-3" :class="addSpouseTogether ? 'border-primary' : 'border-secondary'">
              <div class="card-header d-flex align-items-center gap-2" style="cursor: pointer;"
                @click="addSpouseTogether = !addSpouseTogether">
                <input type="checkbox" class="form-check-input" x-model="addSpouseTogether" @click.stop>
                <i class="bi bi-heart-fill text-danger"></i>
                <span>配偶者も一緒に登録する</span>
              </div>
              <div class="card-body" x-show="addSpouseTogether" x-transition>
                <div class="row mb-3">
                  <div class="col-6">
                    <label class="form-label">配偶者の姓</label>
                    <input type="text" class="form-control" x-model="newSpouse.lastName"
                      :placeholder="newMember.lastName || '山田'"
                      x-init="$watch('newMember.lastName', val => { if (!newSpouse.lastName) newSpouse.lastName = val; })">
                    <small class="text-muted">本人の姓から自動コピー（編集可）</small>
                  </div>
                  <div class="col-6">
                    <label class="form-label">配偶者の名 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" x-model="newSpouse.firstName" placeholder="花子">
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">生年月日</label>
                  <input type="date" class="form-control" x-model="newSpouse.birthDate">
                </div>
                <div class="mb-3">
                  <label class="form-label">登録区分</label>
                  <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="spouseRegistry" id="spouseRegistryMagomago"
                      value="magomago" x-model="newSpouse.registry">
                    <label class="btn btn-outline-success" for="spouseRegistryMagomago">
                      <i class="bi bi-emoji-smile"></i> まごまご会
                    </label>
                    <input type="radio" class="btn-check" name="spouseRegistry" id="spouseRegistryTengoku"
                      value="tengoku" x-model="newSpouse.registry">
                    <label class="btn btn-outline-info" for="spouseRegistryTengoku">
                      <i class="bi bi-cloud"></i> 天国会
                    </label>
                  </div>
                </div>
                <div class="mb-3" x-show="newSpouse.registry === 'tengoku'" x-transition>
                  <label class="form-label">入会日</label>
                  <input type="date" class="form-control" x-model="newSpouse.passedAt">
                </div>
                <div class="alert alert-info mb-0">
                  <i class="bi bi-info-circle"></i>
                  本人と配偶者は相互にリンクされ、家系図で横並びに表示されます。
                </div>
              </div>
            </div>

            <hr>

            <!-- 連絡先情報 -->
            <h6 class="text-muted mb-3"><i class="bi bi-telephone"></i> 連絡先情報</h6>

            <div class="mb-3">
              <label class="form-label">電話番号</label>
              <input type="tel" class="form-control" x-model="newMember.phone" placeholder="090-1234-5678">
            </div>

            <div class="mb-3">
              <label class="form-label">住所</label>
              <textarea class="form-control" rows="2" x-model="newMember.address" placeholder="東京都渋谷区..."></textarea>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="bi bi-x-lg"></i> キャンセル
            </button>
            <button type="button" class="btn btn-primary" @click="saveMember()" :disabled="!isFormValid">
              <i class="bi bi-check-lg"></i> 登録する
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ======================================== -->
    <!-- メンバー情報表示モーダル（和モダン） -->
    <!-- ======================================== -->
    <div class="modal fade" id="viewMemberModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" x-show="viewMember"
          style="border: none; border-radius: 16px; overflow: hidden; background: linear-gradient(135deg, #FDFBF7 0%, #F5F3EF 100%);">

          <!-- ヘッダー（和紙調） -->
          <div class="modal-header border-0 pb-0" style="background: transparent;">
            <button type="button" class="btn-close" data-bs-dismiss="modal" style="opacity: 0.5;"></button>
          </div>

          <div class="modal-body pt-0 px-4">
            <!-- 名前（明朝体・中央） -->
            <div class="text-center mb-4">
              <div
                style="font-family: 'Noto Serif JP', serif; font-size: 1.75rem; font-weight: 500; color: #2F353B; letter-spacing: 0.1em;"
                x-text="`${viewMember?.lastName} ${viewMember?.firstName}`"></div>

              <!-- 天国会員は鳩マーク -->
              <div x-show="viewMember?.registry === 'tengoku'" class="mt-2" style="color: #8B8B8B; font-size: 0.9rem;">
                <span style="font-size: 1.2rem;">🕊️</span> 天国会員
              </div>
            </div>

            <!-- 区切り線（墨線風） -->
            <div
              style="height: 2px; background: linear-gradient(to right, transparent, #2F353B, transparent); opacity: 0.3; margin: 0 20px 24px;">
            </div>

            <!-- 情報グリッド -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">

              <!-- 世代 -->
              <div class="text-center">
                <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;">世代</div>
                <div style="font-family: 'Noto Serif JP', serif; font-size: 1.1rem; color: #2F353B;"
                  x-text="`第${viewMember?.generation}世代`"></div>
              </div>

              <!-- 枝番 -->
              <div class="text-center">
                <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;">枝番</div>
                <div style="font-family: 'Noto Serif JP', serif; font-size: 1.1rem; color: #2F353B;"
                  x-text="branchLabels[viewMember?.branchId] || '始祖'"></div>
              </div>

              <!-- 生年月日 -->
              <div class="text-center" x-show="viewMember?.birthDate">
                <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;">生年月日</div>
                <div style="font-family: 'Noto Serif JP', serif; font-size: 1.1rem; color: #2F353B;"
                  x-text="viewMember?.birthDate"></div>
              </div>

              <!-- 年齢 -->
              <div class="text-center" x-show="viewMember?.birthDate">
                <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;"
                  x-text="viewMember?.registry === 'tengoku' ? '享年' : '年齢'"></div>
                <div style="font-family: 'Noto Serif JP', serif; font-size: 1.1rem; color: #2F353B;">
                  <span
                    x-text="calculateAge(viewMember?.birthDate, viewMember?.registry === 'tengoku' ? viewMember?.passedAt : null)"></span>歳
                </div>
              </div>
            </div>

            <!-- 永眠日（天国会員のみ） -->
            <div x-show="viewMember?.registry === 'tengoku' && viewMember?.passedAt" class="text-center mb-4"
              style="padding: 12px; background: rgba(139, 139, 139, 0.08); border-radius: 8px;">
              <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;">永眠日</div>
              <div style="font-family: 'Noto Serif JP', serif; font-size: 1rem; color: #8B8B8B;"
                x-text="viewMember?.passedAt"></div>
            </div>

            <!-- 配偶者 -->
            <div x-show="viewMember?.spouseId" class="text-center mb-4">
              <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;">
                <span style="color: #c0392b;">♥</span> 配偶者
              </div>
              <div style="font-family: 'Noto Serif JP', serif; font-size: 1rem; color: #2F353B;"
                x-text="getSpouseDisplayName(viewMember?.spouseId)"></div>
            </div>

            <!-- 区切り線 -->
            <div x-show="viewMember?.phone || viewMember?.address"
              style="height: 1px; background: #e0ddd8; margin: 0 0 20px;"></div>

            <!-- 連絡先情報 -->
            <div x-show="viewMember?.phone || viewMember?.address" style="margin-bottom: 8px;">

              <!-- 電話番号 -->
              <div x-show="viewMember?.phone" class="mb-3">
                <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;">電話番号</div>
                <a :href="`tel:${viewMember?.phone}`"
                  style="font-size: 1rem; color: #2F353B; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e0ddd8;">
                  <i class="bi bi-telephone" style="color: #4a5d23;"></i>
                  <span x-text="viewMember?.phone"></span>
                </a>
              </div>

              <!-- 住所 -->
              <div x-show="viewMember?.address">
                <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;">住所</div>
                <div
                  style="font-size: 0.95rem; color: #2F353B; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e0ddd8;">
                  <i class="bi bi-geo-alt" style="color: #c0392b; margin-right: 6px;"></i>
                  <span x-text="viewMember?.address"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- フッター -->
          <div class="modal-footer border-0 justify-content-center gap-3 pb-4" style="background: transparent;">
            <button type="button" class="btn" data-bs-dismiss="modal"
              style="padding: 10px 24px; border: 1px solid #d0cdc8; background: white; color: #666; border-radius: 24px;">
              閉じる
            </button>
            <button type="button" class="btn" @click="openEditFromView()"
              style="padding: 10px 24px; background: #2F353B; color: white; border: none; border-radius: 24px;">
              <i class="bi bi-pencil me-1"></i> 編集する
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ======================================== -->
    <!-- メンバー編集モーダル -->
    <!-- ======================================== -->
    <div class="modal fade" id="editMemberModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content" x-show="editMember">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title"><i class="bi bi-pencil"></i> メンバー情報編集</h5>
            <button type="button" class="btn-close" @click="cancelEdit()"></button>
          </div>
          <div class="modal-body">
            <!-- 読み取り専用情報 -->
            <div class="alert alert-light mb-3">
              <small class="text-muted">
                <i class="bi bi-info-circle"></i>
                世代と枝番は変更できません
              </small>
              <div class="mt-2">
                <span class="badge bg-secondary" x-text="`第${editMember?.generation}世代`"></span>
                <span class="badge bg-secondary ms-1" x-text="branchLabels[editMember?.branchId] || '始祖'"></span>
              </div>
            </div>

            <!-- 基本情報 -->
            <div class="row mb-3">
              <div class="col-6">
                <label class="form-label">姓</label>
                <input type="text" class="form-control" x-model="editMember.lastName">
              </div>
              <div class="col-6">
                <label class="form-label">名</label>
                <input type="text" class="form-control" x-model="editMember.firstName">
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">生年月日</label>
              <input type="date" class="form-control" x-model="editMember.birthDate">
            </div>

            <div class="mb-3">
              <label class="form-label">登録区分</label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="editRegistry" id="editRegistryMagomago" value="magomago"
                  x-model="editMember.registry">
                <label class="btn btn-outline-success" for="editRegistryMagomago">
                  <i class="bi bi-emoji-smile"></i> まごまご会
                </label>

                <input type="radio" class="btn-check" name="editRegistry" id="editRegistryTengoku" value="tengoku"
                  x-model="editMember.registry">
                <label class="btn btn-outline-info" for="editRegistryTengoku">
                  <i class="bi bi-cloud"></i> 天国会
                </label>
              </div>
            </div>

            <div class="mb-3" x-show="editMember?.registry === 'tengoku'" x-transition>
              <label class="form-label">入会日</label>
              <input type="date" class="form-control" x-model="editMember.passedAt">
            </div>

            <!-- 配偶者情報 -->
            <div class="mb-3">
              <label class="form-label"><i class="bi bi-heart-fill text-danger"></i> 配偶者</label>

              <!-- 配偶者が設定されている場合 -->
              <div x-show="editMember?.spouseId" class="card border-danger">
                <div class="card-body d-flex justify-content-between align-items-center py-2">
                  <span>
                    <i class="bi bi-heart text-danger"></i>
                    <strong x-text="getSpouseDisplayName(editMember?.spouseId)"></strong>
                  </span>
                  <button type="button" class="btn btn-outline-secondary btn-sm" @click="unlinkSpouse()">
                    <i class="bi bi-link-45deg"></i> リンク解除
                  </button>
                </div>
              </div>

              <!-- 配偶者が設定されていない場合：検索式 -->
              <div x-show="!editMember?.spouseId">
                <!-- 検索入力 -->
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-search"></i></span>
                  <input type="text" class="form-control" x-model="spouseSearchQuery" placeholder="名前で配偶者を検索..."
                    @focus="showSpouseDropdown = true">
                </div>

                <!-- 候補リスト -->
                <div class="list-group mt-2" x-show="spouseSearchQuery.length > 0"
                  style="max-height: 200px; overflow-y: auto;">
                  <template x-for="member in filteredSpouseCandidates" :key="member.id">
                    <button type="button" class="list-group-item list-group-item-action" @click="selectSpouse(member)">
                      <div class="d-flex justify-content-between align-items-center">
                        <span x-text="`${member.lastName} ${member.firstName}`"></span>
                        <small class="text-muted"
                          x-text="`第${member.generation}世代 - ${branchLabels[member.branchId] || '始祖'}`"></small>
                      </div>
                    </button>
                  </template>
                  <div class="list-group-item text-muted text-center" x-show="filteredSpouseCandidates.length === 0">
                    候補が見つかりません
                  </div>
                </div>

                <!-- 説明 -->
                <small class="text-muted mt-2 d-block" x-show="spouseSearchQuery.length === 0">
                  <i class="bi bi-info-circle"></i> 名前を入力して配偶者を検索してください
                </small>
              </div>
            </div>

            <hr>

            <!-- 連絡先情報 -->
            <h6 class="text-muted mb-3"><i class="bi bi-telephone"></i> 連絡先情報</h6>

            <div class="mb-3">
              <label class="form-label">電話番号</label>
              <input type="tel" class="form-control" x-model="editMember.phone" placeholder="090-1234-5678">
            </div>

            <div class="mb-3">
              <label class="form-label">住所</label>
              <textarea class="form-control" rows="2" x-model="editMember.address" placeholder="東京都渋谷区..."></textarea>
            </div>
          </div>

          <div class="modal-footer d-flex justify-content-between">
            <button type="button" class="btn btn-outline-danger" @click="deleteMember()">
              <i class="bi bi-trash"></i> 削除
            </button>
            <div>
              <button type="button" class="btn btn-secondary" @click="cancelEdit()">
                <i class="bi bi-x-lg"></i> キャンセル
              </button>
              <button type="button" class="btn btn-warning" @click="saveEdit()">
                <i class="bi bi-check-lg"></i> 更新する
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ======================================== -->
    <!-- 削除確認モーダル -->
    <!-- ======================================== -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> 削除の確認</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="text-center mb-3">
              <i class="bi bi-person-x text-danger" style="font-size: 3rem;"></i>
            </div>
            <p class="text-center mb-3" x-text="deleteConfirmMessage"></p>

            <!-- 配偶者同時削除オプション -->
            <div x-show="deleteSpouseOption" class="alert alert-warning">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="deleteSpouseCheck" x-model="deleteSpouseTogether">
                <label class="form-check-label" for="deleteSpouseCheck">
                  <i class="bi bi-heart-fill text-danger"></i>
                  配偶者「<span x-text="deleteSpouseName"></span>」も一緒に削除する
                </label>
              </div>
            </div>

            <div class="alert alert-secondary mb-0">
              <small><i class="bi bi-info-circle"></i> この操作は取り消せません。</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="bi bi-x-lg"></i> キャンセル
            </button>
            <button type="button" class="btn btn-danger" @click="executeDelete()">
              <i class="bi bi-trash"></i> 削除する
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ======================================== -->
    <!-- 成功通知モーダル -->
    <!-- ======================================== -->
    <div class="modal fade" id="successModal" tabindex="-1">
      <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center py-4">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
            <h5 class="mt-3" x-text="successMessage || '完了しました！'"></h5>
          </div>
          <div class="modal-footer justify-content-center border-0 pt-0">
            <button type="button" class="btn btn-success" data-bs-dismiss="modal">
              OK
            </button>
          </div>
        </div>
      </div>
    </div>

  </div> <!-- /isAuthenticated -->

  <!-- ======================================== -->
  <!-- 更新通知バナー -->
  <!-- ======================================== -->
  <div id="updateBanner"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 16px; text-align: center; z-index: 9999; cursor: pointer;"
    onclick="applyUpdate()">
    <i class="bi bi-arrow-clockwise me-2"></i>新しいバージョンがあります。タップして更新
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App Entry Point -->
  <script type="module" src="/src/main.js"></script>

  <!-- ============================================
       バージョン管理 & 自動更新スクリプト
       ============================================ -->
  <script>
    // ============================================
    // アプリバージョン（version.jsonと同期）
    // ============================================
    const APP_VERSION = '1.0.2';

    // ============================================
    // 更新を適用する関数（バナータップ時に呼ばれる）
    // ============================================
    function applyUpdate() {
      location.reload(true);
    }

    // ============================================
    // 更新バナーを表示
    // ============================================
    function showUpdateBanner() {
      const banner = document.getElementById('updateBanner');
      if (banner) {
        banner.style.display = 'block';
      }
    }

    // ============================================
    // バージョンチェック機能（確実な自動更新）
    // ============================================
    async function checkAppVersion() {
      try {
        // キャッシュを無効にしてversion.jsonを取得
        const response = await fetch('/version.json?t=' + Date.now(), {
          cache: 'no-store',
          headers: { 'Cache-Control': 'no-cache' }
        });

        if (!response.ok) {
          console.log('[Version] version.json取得失敗:', response.status);
          return;
        }

        const data = await response.json();
        const serverVersion = data.version;

        console.log('[Version] サーバー:', serverVersion, 'ローカル:', APP_VERSION);

        // バージョンが異なる場合は自動リロード
        if (serverVersion && serverVersion !== APP_VERSION) {
          console.log('[Version] 新しいバージョンを検出！自動更新します...');

          // キャッシュをクリア
          if ('caches' in window) {
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map(name => caches.delete(name)));
            console.log('[Version] キャッシュクリア完了');
          }

          // ページをリロード（キャッシュ無効）
          window.location.reload(true);
        }
      } catch (error) {
        console.log('[Version] チェック失敗（オフライン?）:', error.message);
      }
    }

    // 起動時にバージョンチェック（少し遅延させてUI表示後に実行）
    document.addEventListener('DOMContentLoaded', () => {
      // バージョン表示を更新
      const versionEl = document.getElementById('appVersionDisplay');
      if (versionEl) {
        versionEl.textContent = 'バージョン v' + APP_VERSION;
      }

      setTimeout(checkAppVersion, 1000);
    });
  </script>
</body>

</html>