<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grand-Family - 山田家 親族名簿</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="/src/styles.css" rel="stylesheet">
</head>

<body x-data="mainApp" x-init="init()">

  <!-- ======================================== -->
  <!-- ログイン画面（未認証時のみ表示） -->
  <!-- ======================================== -->
  <div x-show="!isAuthenticated" x-cloak class="login-screen">
    <div class="login-card">
      <div class="login-header">
        <img src="/竹の無料素材2.svg" alt="竹" class="login-icon">
        <h1 class="login-title">デジタルまごまご会名簿</h1>
      </div>

      <form @submit.prevent="onLoginSuccess()" class="login-form">
        <div class="login-input-group">
          <label class="login-label" for="loginId">
            <i class="bi bi-person"></i> ID
          </label>
          <input type="text" id="loginId" class="login-input" x-model="loginId" placeholder="IDを入力"
            autocomplete="username">
        </div>

        <div class="login-input-group">
          <label class="login-label" for="loginPassword">
            <i class="bi bi-calendar3"></i> 生年月日
          </label>
          <div class="password-input-wrapper">
            <input :type="showPassword ? 'text' : 'password'" id="loginPassword" class="login-input"
              x-model="loginPassword" placeholder="8桁（例: 19560423）" inputmode="numeric" maxlength="8"
              autocomplete="current-password"
              @input="loginPassword = loginPassword.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/[^0-9]/g, '')">
            <button type="button" class="password-toggle-btn" @click="showPassword = !showPassword" tabindex="-1">
              <i class="bi" :class="showPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
            </button>
          </div>
        </div>

        <div x-show="loginError" x-cloak class="login-error">
          <i class="bi bi-exclamation-circle"></i>
          <span x-text="loginError"></span>
        </div>

        <button type="submit" class="login-btn" :disabled="isLoggingIn">
          <span x-show="!isLoggingIn">
            <i class="bi bi-box-arrow-in-right"></i> ログイン
          </span>
          <span x-show="isLoggingIn">
            <i class="bi bi-hourglass-split"></i> 確認中...
          </span>
        </button>
      </form>

      <div class="login-footer">
        <small>生年月日は名簿に登録されている方のみ有効です</small>
      </div>
    </div>
  </div>

  <!-- ======================================== -->
  <!-- メインコンテンツ（認証後のみ表示） -->
  <!-- ======================================== -->
  <div x-show="isAuthenticated" x-cloak>

    <!-- ナビゲーションバー -->
    <nav class="navbar">
      <div class="container">
        <a class="navbar-brand" href="#">
          <img src="/竹の無料素材2.svg" alt="竹" class="navbar-icon"> デジタルまごまご会
        </a>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-dark btn-sm" data-bs-toggle="modal" data-bs-target="#addMemberModal">
            <i class="bi bi-plus-lg"></i> 新規登録
          </button>
          <button class="btn btn-outline-secondary btn-sm" @click="logout()">
            <i class="bi bi-box-arrow-right"></i>
          </button>
        </div>
      </div>
    </nav>

    <!-- メインコンテンツ -->
    <div class="container mt-4">
      <!-- スティッキー・タブナビゲーション（ピルスタイル） -->
      <div class="sticky-nav-container">
        <ul class="nav nav-pills-custom justify-content-center mb-3" role="tablist">
          <li class="nav-item">
            <button class="nav-pill" :class="{ active: currentView === 'magomago' }" @click="currentView = 'magomago'">
              <i class="bi bi-people"></i> まごまご会
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-pill" :class="{ active: currentView === 'tengoku' }" @click="currentView = 'tengoku'">
              <i class="bi bi-cloud"></i> 天国会
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-pill" :class="{ active: currentView === 'tree' }" @click="currentView = 'tree'">
              <i class="bi bi-diagram-3"></i> 家系図
            </button>
          </li>
        </ul>
      </div>

      <!-- まごまご会名簿（全員） -->
      <div x-show="currentView === 'magomago'" x-data="{ isSearchExpanded: false }">

        <!-- コントロール・ハブ：枝番フィルタ + 検索 -->
        <div class="control-hub d-flex align-items-center mb-4">

          <!-- 左：枝番フィルター（横スクロールチップス） -->
          <div class="branch-chips-container flex-grow-1 overflow-auto">
            <div class="branch-chips d-flex gap-2 py-2">
              <button class="branch-chip" :class="selectedBranchId === null ? 'active' : ''"
                @click="selectedBranchId = null">
                <i class="bi bi-check2" x-show="selectedBranchId === null"></i>
                全て
              </button>
              <template x-for="i in 9" :key="i">
                <button class="branch-chip" :class="selectedBranchId === i ? 'active' : ''"
                  @click="selectedBranchId = i">
                  <i class="bi bi-check2" x-show="selectedBranchId === i"></i>
                  <span x-text="branchLabels[i]"></span>
                </button>
              </template>
            </div>
          </div>

          <!-- 右：検索トリガー -->
          <div class="ms-3 flex-shrink-0">
            <button type="button" class="search-toggle-btn"
              @click="isSearchExpanded = !isSearchExpanded; if(isSearchExpanded) $nextTick(() => $refs.searchInput.focus()); else searchQuery = '';">
              <i class="bi" :class="isSearchExpanded ? 'bi-x-lg' : 'bi-search'"></i>
            </button>
          </div>
        </div>

        <!-- 展開式検索バー -->
        <div class="search-bar-container mb-4" :class="isSearchExpanded ? 'expanded' : ''">
          <div class="search-bar-inner">
            <i class="bi bi-search text-muted"></i>
            <input type="text" class="search-input" placeholder="名前で検索..." x-model="searchQuery" x-ref="searchInput"
              @keydown.escape="isSearchExpanded = false; searchQuery = '';">
            <!-- クリアボタン -->
            <button type="button" class="search-clear-btn" x-show="searchQuery.length > 0"
              @click="searchQuery = ''; $refs.searchInput.focus();">
              <i class="bi bi-x-circle-fill"></i>
            </button>
          </div>
        </div>

        <!-- 選択中の枝番のメンバーリスト -->
        <template
          x-for="branch in membersByBranch.filter(b => selectedBranchId === null || b.branchId === selectedBranchId)"
          :key="branch.branchId">
          <div class="card branch-card mb-4">
            <!-- 枝番ヘッダー（カードヘッダー） -->
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="bi bi-signpost-split text-primary"></i>
                <span x-text="branch.branchName"></span>
              </h5>
              <span class="badge bg-primary" x-text="`${branch.members.length}名`"></span>
            </div>

            <!-- メンバーリスト（カードボディ） -->
            <div class="list-group list-group-flush">
              <template x-for="member in branch.members" :key="member.id">
                <div class="list-group-item list-group-item-action"
                  :class="{ 'bg-light': member.registry === 'tengoku' }" style="cursor: pointer;"
                  @click="openViewMember(member)">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <!-- 名前と天国会員バッジ -->
                      <div class="d-flex align-items-center gap-2 mb-1">
                        <strong x-text="`${member.lastName} ${member.firstName}`"></strong>
                        <span class="badge ms-1" x-show="member.registry === 'tengoku'"
                          style="background-color: #4a5d23; color: white;">
                          <i class="bi bi-cloud"></i> 天国会員
                        </span>
                      </div>
                      <!-- 詳細情報 -->
                      <div class="small text-muted">
                        <span x-text="`第${member.generation}世代`"></span>
                        <template x-if="member.birthDate">
                          <span>
                            ｜ <i class="bi bi-cake2"></i>
                            <span x-text="member.birthDate"></span>
                            (<span
                              x-text="calculateAge(member.birthDate, member.registry === 'tengoku' ? member.passedAt : null)"></span>歳<span
                              x-show="member.registry === 'tengoku'">で永眠</span>)
                          </span>
                        </template>
                      </div>
                      <div class="small text-muted mt-1" x-show="member.phone || member.address">
                        <template x-if="member.phone">
                          <span>
                            <i class="bi bi-telephone"></i>
                            <a :href="`tel:${member.phone}`" class="text-decoration-none" @click.stop
                              x-text="member.phone"></a>
                          </span>
                        </template>
                        <template x-if="member.address">
                          <span :class="{ 'ms-2': member.phone }">
                            <i class="bi bi-geo-alt"></i>
                            <span x-text="member.address"></span>
                          </span>
                        </template>
                      </div>
                    </div>
                    <button class="btn btn-link text-muted p-0" style="font-size: 0.7rem; opacity: 0.4;"
                      @click.stop="openEditMember(member)" title="情報を修正">
                      <i class="bi bi-pencil"></i>
                    </button>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>

        <div class="text-center text-muted py-4" x-show="membersByBranch.length === 0">
          メンバーがいません
        </div>
      </div>

      <!-- 天国会名簿（故人） -->
      <div x-show="currentView === 'tengoku'"
        x-data="{ isSearchExpanded: false, tengokuSearchQuery: '', selectedTengokuBranchId: null }">

        <!-- コントロール・ハブ：枝番フィルタ + 検索 -->
        <div class="control-hub d-flex align-items-center mb-4">

          <!-- 左：枝番フィルター（横スクロールチップス） -->
          <div class="branch-chips-container flex-grow-1 overflow-auto">
            <div class="branch-chips d-flex gap-2 py-2">
              <button class="branch-chip" :class="selectedTengokuBranchId === null ? 'active' : ''"
                @click="selectedTengokuBranchId = null">
                <i class="bi bi-check2" x-show="selectedTengokuBranchId === null"></i>
                全て
              </button>
              <template x-for="i in 9" :key="i">
                <button class="branch-chip" :class="selectedTengokuBranchId === i ? 'active' : ''"
                  @click="selectedTengokuBranchId = i">
                  <i class="bi bi-check2" x-show="selectedTengokuBranchId === i"></i>
                  <span x-text="branchLabels[i]"></span>
                </button>
              </template>
            </div>
          </div>

          <!-- 右：検索トリガー -->
          <div class="ms-3 flex-shrink-0">
            <button type="button" class="search-toggle-btn"
              @click="isSearchExpanded = !isSearchExpanded; if(isSearchExpanded) $nextTick(() => $refs.tengokuSearchInput.focus()); else tengokuSearchQuery = '';">
              <i class="bi" :class="isSearchExpanded ? 'bi-x-lg' : 'bi-search'"></i>
            </button>
          </div>
        </div>

        <!-- 展開式検索バー -->
        <div class="search-bar-container mb-4" :class="isSearchExpanded ? 'expanded' : ''">
          <div class="search-bar-inner">
            <i class="bi bi-search text-muted"></i>
            <input type="text" class="search-input" placeholder="名前で検索..." x-model="tengokuSearchQuery"
              x-ref="tengokuSearchInput" @keydown.escape="isSearchExpanded = false; tengokuSearchQuery = '';">
            <!-- クリアボタン -->
            <button type="button" class="search-clear-btn" x-show="tengokuSearchQuery.length > 0"
              @click="tengokuSearchQuery = ''; $refs.tengokuSearchInput.focus();">
              <i class="bi bi-x-circle-fill"></i>
            </button>
          </div>
        </div>

        <!-- 枝番ごとのカード -->
        <template
          x-for="branchId in [null, 1, 2, 3, 4, 5, 6, 7, 8, 9].filter(id => selectedTengokuBranchId === null || selectedTengokuBranchId === id)"
          :key="branchId ?? 'all'">
          <template
            x-if="tengokuMembers.filter(m => (branchId === null || m.branchId === branchId) && (tengokuSearchQuery === '' || `${m.lastName}${m.firstName}`.toLowerCase().includes(tengokuSearchQuery.toLowerCase()))).length > 0">
            <div class="card branch-card mb-4" x-show="branchId !== null">
              <!-- 枝番ヘッダー -->
              <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                  <i class="bi bi-signpost-split text-primary"></i>
                  <span x-text="branchLabels[branchId] || '始祖'"></span>
                </h5>
                <span class="badge bg-primary"
                  x-text="`${tengokuMembers.filter(m => m.branchId === branchId && (tengokuSearchQuery === '' || `${m.lastName}${m.firstName}`.toLowerCase().includes(tengokuSearchQuery.toLowerCase()))).length}名`"></span>
              </div>

              <!-- メンバーリスト -->
              <div class="list-group list-group-flush">
                <template
                  x-for="member in tengokuMembers.filter(m => m.branchId === branchId && (tengokuSearchQuery === '' || `${m.lastName}${m.firstName}`.toLowerCase().includes(tengokuSearchQuery.toLowerCase())))"
                  :key="member.id">
                  <div class="list-group-item list-group-item-action bg-light" style="cursor: pointer;"
                    @click="openViewMember(member)">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1">
                        <!-- 名前 -->
                        <div class="d-flex align-items-center gap-2 mb-1">
                          <strong x-text="`${member.lastName} ${member.firstName}`"></strong>
                        </div>
                        <!-- 詳細情報 -->
                        <div class="small text-muted">
                          <span x-text="`第${member.generation}世代`"></span>
                          <template x-if="member.passedAt">
                            <span>
                              ｜ <i class="bi bi-cloud"></i>
                              <span x-text="member.passedAt"></span>
                              (享年<span x-text="calculateAge(member.birthDate, member.passedAt)"></span>歳)
                            </span>
                          </template>
                        </div>
                      </div>
                      <button class="btn btn-link text-muted p-0" style="font-size: 0.7rem; opacity: 0.4;"
                        @click.stop="openEditMember(member)" title="情報を修正">
                        <i class="bi bi-pencil"></i>
                      </button>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </template>
        </template>

        <div class="text-center text-muted py-4" x-show="tengokuMembers.length === 0">
          メンバーがいません
        </div>
      </div>

      <div x-show="currentView === 'tree'" x-init="$watch('currentView', v => { if (v === 'tree') initTree(); })"
        class="position-relative">

        <!-- 家系図コンテナ -->
        <div id="family-tree-container" class="family-tree-washi">
        </div>

        <!-- コントロール・ドック（右下フロート） -->
        <div class="control-dock">
          <button class="control-dock-btn" @click="resetZoom()" title="始祖へ戻る">
            <i class="bi bi-house-door"></i>
          </button>
          <button class="control-dock-btn" @click="fitToView()" title="全体を表示">
            <i class="bi bi-arrows-fullscreen"></i>
          </button>
          <div class="control-dock-divider"></div>
          <button class="control-dock-btn" @click="zoomIn()" title="拡大">
            <i class="bi bi-plus-lg"></i>
          </button>
          <button class="control-dock-btn" @click="zoomOut()" title="縮小">
            <i class="bi bi-dash-lg"></i>
          </button>
          <div class="control-dock-divider"></div>
          <button class="control-dock-btn" @click="toggleExpandAll()" title="全て展開/折りたたみ">
            <i class="bi bi-diagram-2"></i>
          </button>
        </div>

        <!-- バージョン情報 -->
        <div class="text-center text-muted mt-3" style="font-size: 0.75rem; opacity: 0.6;">
          <span id="appVersionDisplay"></span>
        </div>
      </div>
    </div>

    <!-- ======================================== -->
    <!-- 新規メンバー登録モーダル -->
    <!-- ======================================== -->
    <div class="modal fade" id="addMemberModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content"
          style="border: none; border-radius: 16px; overflow: hidden; background: linear-gradient(135deg, #FDFBF7 0%, #F5F3EF 100%);">

          <!-- ヘッダー（和モダン） -->
          <div class="modal-header border-0 pb-2" style="background: transparent;">
            <div class="w-100 text-center pt-2">
              <div
                style="font-family: 'Noto Serif JP', serif; font-size: 1.5rem; font-weight: 500; color: #2F353B; letter-spacing: 0.1em;">
                新規メンバー登録
              </div>
            </div>
            <button type="button" class="btn-close position-absolute" data-bs-dismiss="modal"
              style="top: 16px; right: 16px; opacity: 0.5;"></button>
          </div>

          <!-- 区切り線（墨線風） -->
          <div
            style="height: 2px; background: linear-gradient(to right, transparent, #2F353B, transparent); opacity: 0.2; margin: 0 40px 16px;">
          </div>

          <div class="modal-body pt-0" style="padding: 0 24px 16px;">

            <!-- 親選択 (インクリメンタル検索) -->
            <div style="background: white; border-radius: 12px; border: 1px solid #e0ddd8; margin-bottom: 20px;">
              <div style="padding: 12px 16px; border-bottom: 1px solid #e0ddd8;">
                <span style="font-family: 'Noto Serif JP', serif; color: #2F353B; font-size: 0.95rem;">
                  <i class="bi bi-arrow-up-circle" style="color: #2D4A6F;"></i> 親（父または母）の選択 <span
                    class="text-danger">*</span>
                </span>
              </div>
              <div style="padding: 16px;">
                <!-- 選択済み表示（クリックで解除） -->
                <div x-show="newMember.parentId"
                  style="padding: 12px 16px; background: rgba(45, 74, 111, 0.1); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;"
                  @click="clearParentSelection()">
                  <i class="bi bi-check-circle" style="color: #2D4A6F;"></i>
                  <strong x-text="getParentDisplayName(newMember.parentId)"></strong>
                  <small style="color: #999; margin-left: auto;">(クリックで変更)</small>
                </div>

                <!-- 検索入力 -->
                <div x-show="!newMember.parentId" style="position: relative;">
                  <i class="bi bi-search"
                    style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #999;"></i>
                  <input type="text" x-model="parentSearchQuery" placeholder="名前で検索..."
                    @focus="showParentDropdown = true"
                    style="width: 100%; padding: 14px 14px 14px 42px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
                </div>

                <!-- 候補リスト -->
                <div x-show="!newMember.parentId && parentSearchQuery.length > 0"
                  style="margin-top: 8px; max-height: 200px; overflow-y: auto; border: 1px solid #e0ddd8; border-radius: 8px;">
                  <template x-for="member in filteredParentCandidates" :key="member.id">
                    <button type="button"
                      style="width: 100%; padding: 12px 16px; border: none; background: white; text-align: left; border-bottom: 1px solid #f0ede8; cursor: pointer;"
                      @click="selectParent(member)" onmouseover="this.style.background='#f5f3ef'"
                      onmouseout="this.style.background='white'">
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span x-text="`${member.lastName} ${member.firstName}`"></span>
                        <small style="color: #999;"
                          x-text="`第${member.generation}世代 - ${branchLabels[member.branchId] || '始祖'}`"></small>
                      </div>
                    </button>
                  </template>
                  <div style="padding: 12px; text-align: center; color: #999;"
                    x-show="filteredParentCandidates.length === 0">
                    候補が見つかりません
                  </div>
                </div>

                <!-- 全員表示（検索クエリが空の場合）-->
                <div style="margin-top: 8px;" x-show="!newMember.parentId && parentSearchQuery.length === 0">
                  <small style="color: #999;">
                    <i class="bi bi-info-circle"></i> 名前を入力して親を検索してください（登録人数: <span x-text="allMembers.length"></span>名）
                  </small>
                </div>
              </div>
            </div>

            <!-- 自動計算フィールド表示 -->
            <div x-show="newMember.parentId" x-transition
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
              <div>
                <label style="font-size: 0.8rem; color: #999; display: block; margin-bottom: 4px;">
                  <i class="bi bi-layers"></i> 世代
                </label>
                <div
                  style="padding: 12px 16px; background: #f5f3ef; border-radius: 8px; font-family: 'Noto Serif JP', serif; color: #2F353B;"
                  x-text="`第${newMember.generation}世代`"></div>
              </div>
              <div>
                <label style="font-size: 0.8rem; color: #999; display: block; margin-bottom: 4px;">
                  <i class="bi bi-signpost-split"></i> 枝番
                </label>
                <!-- 始祖が親以外の場合: 読み取り専用 -->
                <div x-show="selectedParentGeneration > 1"
                  style="padding: 12px 16px; background: #f5f3ef; border-radius: 8px; font-family: 'Noto Serif JP', serif; color: #2F353B;"
                  x-text="branchLabels[newMember.branchId] || ''"></div>
                <!-- 始祖が親の場合: 枝番を手動選択 -->
                <select x-model.number="newMember.branchId" x-show="selectedParentGeneration === 1"
                  style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;"
                  :style="selectedParentGeneration === 1 && !newMember.branchId ? 'border-color: #c0392b;' : ''">
                  <option value="">枝番を選択 *</option>
                  <template x-for="i in 9" :key="i">
                    <option :value="i" x-text="branchLabels[i]"></option>
                  </template>
                </select>
                <small x-show="selectedParentGeneration === 1 && !newMember.branchId"
                  style="color: #c0392b; font-size: 0.75rem;">
                  <i class="bi bi-exclamation-triangle"></i> 枝番を選択してください
                </small>
              </div>
            </div>

            <!-- 区切り線 -->
            <div style="height: 1px; background: #e0ddd8; margin: 0 0 20px;"></div>

            <!-- 基本情報 -->
            <div style="font-family: 'Noto Serif JP', serif; font-size: 0.95rem; color: #2F353B; margin-bottom: 16px;">
              <i class="bi bi-person" style="color: #4a5d23;"></i> 基本情報
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">
                  姓 <span style="color: #c0392b;">*</span>
                </label>
                <input type="text" x-model="newMember.lastName" placeholder="山田"
                  style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
              </div>
              <div>
                <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">
                  名 <span style="color: #c0392b;">*</span>
                </label>
                <input type="text" x-model="newMember.firstName" placeholder="太郎"
                  style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
              </div>
            </div>

            <div style="margin-bottom: 16px;">
              <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">
                <i class="bi bi-translate" style="color: #2D4A6F;"></i> ローマ字表記
              </label>
              <input type="text" x-model="newMember.romanizedName" placeholder="Taro Yamada"
                @blur="newMember.romanizedName = formatRomanizedName(newMember.romanizedName)"
                style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7; font-style: italic;">
              <small style="color: #999; font-size: 0.75rem;">
                <i class="bi bi-info-circle"></i> 入力後、自動的に Taro Yamada 形式に変換されます
              </small>
            </div>

            <div style="margin-bottom: 16px;">
              <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">生年月日</label>
              <input type="text" x-model="newMember.birthDate" placeholder="19900101" inputmode="numeric"
                @blur="newMember.birthDate = formatDateInput(newMember.birthDate)"
                style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
            </div>

            <div style="margin-bottom: 16px;">
              <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 8px;">登録区分</label>
              <div style="display: flex; gap: 12px;">
                <label @click="newMember.registry = 'magomago'"
                  style="flex: 1; padding: 12px 16px; border-radius: 8px; cursor: pointer; text-align: center;" :style="newMember.registry === 'magomago' 
                    ? { background: '#4a5d23', color: 'white', border: '1px solid #4a5d23' } 
                    : { background: 'white', color: '#666', border: '1px solid #e0ddd8' }">
                  <i class="bi bi-emoji-smile"></i> まごまご会
                </label>
                <label @click="newMember.registry = 'tengoku'"
                  style="flex: 1; padding: 12px 16px; border-radius: 8px; cursor: pointer; text-align: center;" :style="newMember.registry === 'tengoku' 
                    ? { background: '#8B8B8B', color: 'white', border: '1px solid #8B8B8B' } 
                    : { background: 'white', color: '#666', border: '1px solid #e0ddd8' }">
                  🕊️ 天国会
                </label>
              </div>
            </div>

            <div x-show="newMember.registry === 'tengoku'" x-transition style="margin-bottom: 16px;">
              <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">入会日（永眠日）</label>
              <input type="text" x-model="newMember.passedAt" placeholder="20200101" inputmode="numeric"
                @blur="newMember.passedAt = formatDateInput(newMember.passedAt)"
                style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
            </div>

            <!-- 区切り線 -->
            <div style="height: 1px; background: #e0ddd8; margin: 0 0 20px;"></div>

            <!-- 配偶者同時登録 -->
            <div style="background: white; border-radius: 12px; border: 1px solid #e0ddd8; margin-bottom: 20px;"
              :style="addSpouseTogether ? 'border-color: #c0392b;' : ''">
              <div
                style="padding: 12px 16px; border-bottom: 1px solid #e0ddd8; cursor: pointer; display: flex; align-items: center; gap: 12px;"
                @click="addSpouseTogether = !addSpouseTogether">
                <input type="checkbox" x-model="addSpouseTogether" @click.stop
                  style="width: 18px; height: 18px; accent-color: #c0392b;">
                <span style="color: #c0392b;">♥</span>
                <span style="font-family: 'Noto Serif JP', serif; color: #2F353B;">配偶者も一緒に登録する</span>
              </div>
              <div x-show="addSpouseTogether" x-transition style="padding: 16px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                  <div>
                    <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">配偶者の姓</label>
                    <input type="text" x-model="newSpouse.lastName" :placeholder="newMember.lastName || '山田'"
                      x-init="$watch('newMember.lastName', val => { if (!newSpouse.lastName) newSpouse.lastName = val; })"
                      style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
                    <small style="color: #999; font-size: 0.75rem;">本人の姓から自動コピー</small>
                  </div>
                  <div>
                    <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">
                      配偶者の名 <span style="color: #c0392b;">*</span>
                    </label>
                    <input type="text" x-model="newSpouse.firstName" placeholder="花子"
                      style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
                  </div>
                </div>
                <div style="margin-bottom: 16px;">
                  <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">
                    <i class="bi bi-translate" style="color: #2D4A6F;"></i> ローマ字表記
                  </label>
                  <input type="text" x-model="newSpouse.romanizedName" placeholder="Hanako Yamada"
                    @blur="newSpouse.romanizedName = formatRomanizedName(newSpouse.romanizedName)"
                    style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7; font-style: italic;">
                </div>
                <div style="margin-bottom: 16px;">
                  <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">生年月日</label>
                  <input type="text" x-model="newSpouse.birthDate" placeholder="19900101" inputmode="numeric"
                    @blur="newSpouse.birthDate = formatDateInput(newSpouse.birthDate)"
                    style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
                </div>
                <div style="margin-bottom: 16px;">
                  <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 8px;">登録区分</label>
                  <div style="display: flex; gap: 12px;">
                    <label @click="newSpouse.registry = 'magomago'"
                      style="flex: 1; padding: 10px 12px; border-radius: 8px; cursor: pointer; text-align: center; font-size: 0.9rem;"
                      :style="newSpouse.registry === 'magomago' 
                        ? { background: '#4a5d23', color: 'white', border: '1px solid #4a5d23' } 
                        : { background: '#FDFBF7', color: '#666', border: '1px solid #e0ddd8' }">
                      まごまご会
                    </label>
                    <label @click="newSpouse.registry = 'tengoku'"
                      style="flex: 1; padding: 10px 12px; border-radius: 8px; cursor: pointer; text-align: center; font-size: 0.9rem;"
                      :style="newSpouse.registry === 'tengoku' 
                        ? { background: '#8B8B8B', color: 'white', border: '1px solid #8B8B8B' } 
                        : { background: '#FDFBF7', color: '#666', border: '1px solid #e0ddd8' }">
                      🕊️ 天国会
                    </label>
                  </div>
                </div>
                <div x-show="newSpouse.registry === 'tengoku'" x-transition style="margin-bottom: 16px;">
                  <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">入会日（永眠日）</label>
                  <input type="text" x-model="newSpouse.passedAt" placeholder="20200101" inputmode="numeric"
                    @blur="newSpouse.passedAt = formatDateInput(newSpouse.passedAt)"
                    style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
                </div>
                <div
                  style="padding: 12px; background: rgba(74, 93, 35, 0.08); border-radius: 8px; color: #4a5d23; font-size: 0.85rem;">
                  <i class="bi bi-info-circle"></i>
                  本人と配偶者は相互にリンクされ、家系図で横並びに表示されます。
                </div>
              </div>
            </div>

            <!-- 区切り線 -->
            <div style="height: 1px; background: #e0ddd8; margin: 0 0 20px;"></div>

            <!-- 連絡先情報 -->
            <div style="font-family: 'Noto Serif JP', serif; font-size: 0.95rem; color: #2F353B; margin-bottom: 16px;">
              <i class="bi bi-telephone" style="color: #4a5d23;"></i> 連絡先情報
            </div>

            <div style="margin-bottom: 16px;">
              <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">電話番号</label>
              <input type="tel" x-model="newMember.phone" placeholder="090-1234-5678"
                style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
            </div>

            <div style="margin-bottom: 16px;">
              <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">住所</label>
              <textarea x-model="newMember.address" placeholder="東京都渋谷区..." rows="2"
                style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7; resize: vertical;"></textarea>
            </div>
          </div>

          <div class="modal-footer border-0 justify-content-center gap-3 pb-4" style="background: transparent;">
            <button type="button" class="btn" data-bs-dismiss="modal"
              style="padding: 12px 28px; border: 1px solid #d0cdc8; background: white; color: #666; border-radius: 24px; font-size: 0.95rem;">
              キャンセル
            </button>
            <button type="button" class="btn" @click="saveMember()" :disabled="!isFormValid"
              style="padding: 12px 28px; background: #4a5d23; color: white; border: none; border-radius: 24px; font-size: 0.95rem;"
              :style="!isFormValid ? 'opacity: 0.5; cursor: not-allowed;' : ''">
              <i class="bi bi-check-lg me-1"></i> 登録する
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ======================================== -->
    <!-- メンバー情報表示モーダル（和モダン） -->
    <!-- ======================================== -->
    <div class="modal fade" id="viewMemberModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" x-show="viewMember"
          style="border: none; border-radius: 16px; overflow: hidden; background: linear-gradient(135deg, #FDFBF7 0%, #F5F3EF 100%);">

          <!-- ヘッダー（和紙調） -->
          <div class="modal-header border-0 pb-0" style="background: transparent;">
            <button type="button" class="btn-close" data-bs-dismiss="modal" style="opacity: 0.5;"></button>
          </div>

          <div class="modal-body pt-0 px-4">
            <!-- 名前（明朝体・中央） -->
            <div class="text-center mb-4">
              <div
                style="font-family: 'Noto Serif JP', serif; font-size: 1.75rem; font-weight: 500; color: #2F353B; letter-spacing: 0.1em;"
                x-text="`${viewMember?.lastName} ${viewMember?.firstName}`"></div>

              <!-- ローマ字表記（スタイリッシュな表示） -->
              <div x-show="viewMember?.romanizedName"
                style="font-family: 'Times New Roman', serif; font-size: 0.95rem; font-style: italic; color: #666; letter-spacing: 0.05em; margin-top: 4px;"
                x-text="viewMember?.romanizedName"></div>

              <!-- 天国会員は鳩マーク -->
              <div x-show="viewMember?.registry === 'tengoku'" class="mt-2" style="color: #8B8B8B; font-size: 0.9rem;">
                <span style="font-size: 1.2rem;">🕊️</span> 天国会員
              </div>
            </div>

            <!-- 区切り線（墨線風） -->
            <div
              style="height: 2px; background: linear-gradient(to right, transparent, #2F353B, transparent); opacity: 0.3; margin: 0 20px 24px;">
            </div>

            <!-- 情報グリッド -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">

              <!-- 世代 -->
              <div class="text-center">
                <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;">世代</div>
                <div style="font-family: 'Noto Serif JP', serif; font-size: 1.1rem; color: #2F353B;"
                  x-text="`第${viewMember?.generation}世代`"></div>
              </div>

              <!-- 枝番 -->
              <div class="text-center">
                <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;">枝番</div>
                <div style="font-family: 'Noto Serif JP', serif; font-size: 1.1rem; color: #2F353B;"
                  x-text="branchLabels[viewMember?.branchId] || '始祖'"></div>
              </div>

              <!-- 生年月日 -->
              <div class="text-center" x-show="viewMember?.birthDate">
                <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;">生年月日</div>
                <div style="font-family: 'Noto Serif JP', serif; font-size: 1.1rem; color: #2F353B;"
                  x-text="viewMember?.birthDate"></div>
              </div>

              <!-- 年齢 -->
              <div class="text-center" x-show="viewMember?.birthDate">
                <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;"
                  x-text="viewMember?.registry === 'tengoku' ? '享年' : '年齢'"></div>
                <div style="font-family: 'Noto Serif JP', serif; font-size: 1.1rem; color: #2F353B;">
                  <span
                    x-text="calculateAge(viewMember?.birthDate, viewMember?.registry === 'tengoku' ? viewMember?.passedAt : null)"></span>歳
                </div>
              </div>
            </div>

            <!-- 永眠日（天国会員のみ） -->
            <div x-show="viewMember?.registry === 'tengoku' && viewMember?.passedAt" class="text-center mb-4"
              style="padding: 12px; background: rgba(139, 139, 139, 0.08); border-radius: 8px;">
              <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;">永眠日</div>
              <div style="font-family: 'Noto Serif JP', serif; font-size: 1rem; color: #8B8B8B;"
                x-text="viewMember?.passedAt"></div>
            </div>

            <!-- 配偶者 -->
            <div x-show="viewMember?.spouseId" class="text-center mb-4">
              <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;">
                <span style="color: #c0392b;">♥</span> 配偶者
              </div>
              <div style="font-family: 'Noto Serif JP', serif; font-size: 1rem; color: #2F353B;"
                x-text="getSpouseDisplayName(viewMember?.spouseId)"></div>
            </div>

            <!-- 区切り線 -->
            <div x-show="viewMember?.phone || viewMember?.address"
              style="height: 1px; background: #e0ddd8; margin: 0 0 20px;"></div>

            <!-- 連絡先情報 -->
            <div x-show="viewMember?.phone || viewMember?.address" style="margin-bottom: 8px;">

              <!-- 電話番号 -->
              <div x-show="viewMember?.phone" class="mb-3">
                <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;">電話番号</div>
                <a :href="`tel:${viewMember?.phone}`"
                  style="font-size: 1rem; color: #2F353B; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e0ddd8;">
                  <i class="bi bi-telephone" style="color: #4a5d23;"></i>
                  <span x-text="viewMember?.phone"></span>
                </a>
              </div>

              <!-- 住所 -->
              <div x-show="viewMember?.address">
                <div style="font-size: 0.75rem; color: #999; margin-bottom: 4px;">住所</div>
                <div
                  style="font-size: 0.95rem; color: #2F353B; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e0ddd8;">
                  <i class="bi bi-geo-alt" style="color: #c0392b; margin-right: 6px;"></i>
                  <span x-text="viewMember?.address"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- フッター -->
          <div class="modal-footer border-0 justify-content-center gap-3 pb-4" style="background: transparent;">
            <button type="button" class="btn" data-bs-dismiss="modal"
              style="padding: 10px 24px; border: 1px solid #d0cdc8; background: white; color: #666; border-radius: 24px;">
              閉じる
            </button>
            <button type="button" class="btn" @click="openEditFromView()"
              style="padding: 10px 24px; background: #2F353B; color: white; border: none; border-radius: 24px;">
              <i class="bi bi-pencil me-1"></i> 編集する
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ======================================== -->
    <!-- メンバー編集モーダル（和モダン） -->
    <!-- ======================================== -->
    <div class="modal fade" id="editMemberModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" x-show="editMember"
          style="border: none; border-radius: 16px; overflow: hidden; background: linear-gradient(135deg, #FDFBF7 0%, #F5F3EF 100%);">

          <!-- ヘッダー -->
          <div class="modal-header border-0 pb-2" style="background: transparent;">
            <div class="w-100 text-center pt-2">
              <div
                style="font-family: 'Noto Serif JP', serif; font-size: 1.5rem; font-weight: 500; color: #2F353B; letter-spacing: 0.1em;">
                メンバー情報編集
              </div>
            </div>
            <button type="button" class="btn-close position-absolute" @click="cancelEdit()"
              style="top: 16px; right: 16px; opacity: 0.5;"></button>
          </div>

          <!-- 区切り線 -->
          <div
            style="height: 2px; background: linear-gradient(to right, transparent, #2F353B, transparent); opacity: 0.2; margin: 0 40px 16px;">
          </div>

          <div class="modal-body pt-0" style="padding: 0 24px 16px;">

            <!-- 読み取り専用情報 -->
            <div style="padding: 12px; background: rgba(45, 74, 111, 0.08); border-radius: 8px; margin-bottom: 20px;">
              <small style="color: #666;">
                <i class="bi bi-info-circle"></i> 世代と枝番は変更できません
              </small>
              <div style="margin-top: 8px; display: flex; gap: 8px;">
                <span
                  style="padding: 4px 12px; background: #2D4A6F; color: white; border-radius: 12px; font-size: 0.8rem;"
                  x-text="`第${editMember?.generation}世代`"></span>
                <span
                  style="padding: 4px 12px; background: #2D4A6F; color: white; border-radius: 12px; font-size: 0.8rem;"
                  x-text="branchLabels[editMember?.branchId] || '始祖'"></span>
              </div>
            </div>

            <!-- 基本情報 -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">姓</label>
                <input type="text" x-model="editMember.lastName"
                  style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
              </div>
              <div>
                <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">名</label>
                <input type="text" x-model="editMember.firstName"
                  style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
              </div>
            </div>

            <div style="margin-bottom: 16px;">
              <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">
                <i class="bi bi-translate" style="color: #2D4A6F;"></i> ローマ字表記
              </label>
              <input type="text" x-model="editMember.romanizedName" placeholder="Taro Yamada"
                @blur="editMember.romanizedName = formatRomanizedName(editMember.romanizedName)"
                style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7; font-style: italic;">
            </div>

            <div style="margin-bottom: 16px;">
              <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">生年月日</label>
              <input type="text" x-model="editMember.birthDate" placeholder="19900101" inputmode="numeric"
                @blur="editMember.birthDate = formatDateInput(editMember.birthDate)"
                style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
            </div>

            <div style="margin-bottom: 16px;">
              <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 8px;">登録区分</label>
              <div style="display: flex; gap: 12px;">
                <label @click="editMember.registry = 'magomago'"
                  style="flex: 1; padding: 12px 16px; border-radius: 8px; cursor: pointer; text-align: center;" :style="editMember.registry === 'magomago' 
                    ? { background: '#4a5d23', color: 'white', border: '1px solid #4a5d23' } 
                    : { background: 'white', color: '#666', border: '1px solid #e0ddd8' }">
                  <i class="bi bi-emoji-smile"></i> まごまご会
                </label>
                <label @click="editMember.registry = 'tengoku'"
                  style="flex: 1; padding: 12px 16px; border-radius: 8px; cursor: pointer; text-align: center;" :style="editMember.registry === 'tengoku' 
                    ? { background: '#8B8B8B', color: 'white', border: '1px solid #8B8B8B' } 
                    : { background: 'white', color: '#666', border: '1px solid #e0ddd8' }">
                  🕊️ 天国会
                </label>
              </div>
            </div>

            <div x-show="editMember?.registry === 'tengoku'" x-transition style="margin-bottom: 16px;">
              <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">入会日（永眠日）</label>
              <input type="text" x-model="editMember.passedAt" placeholder="20200101" inputmode="numeric"
                @blur="editMember.passedAt = formatDateInput(editMember.passedAt)"
                style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
            </div>

            <!-- 配偶者情報 -->
            <div style="margin-bottom: 16px;">
              <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 8px;">
                <span style="color: #c0392b;">♥</span> 配偶者
              </label>

              <!-- 配偶者が設定されている場合 -->
              <div x-show="editMember?.spouseId"
                style="padding: 12px 16px; background: white; border: 1px solid #e0ddd8; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <span>
                  <span style="color: #c0392b;">♥</span>
                  <strong x-text="getSpouseDisplayName(editMember?.spouseId)"></strong>
                </span>
                <button type="button" @click="unlinkSpouse()"
                  style="padding: 6px 12px; border: 1px solid #d0cdc8; background: white; color: #666; border-radius: 16px; font-size: 0.8rem; cursor: pointer;">
                  リンク解除
                </button>
              </div>

              <!-- 配偶者が設定されていない場合：検索式 -->
              <div x-show="!editMember?.spouseId">
                <!-- 検索入力 -->
                <div style="position: relative;" x-show="!showNewSpouseForm">
                  <i class="bi bi-search"
                    style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #999;"></i>
                  <input type="text" x-model="spouseSearchQuery" placeholder="名前で配偶者を検索..."
                    @focus="showSpouseDropdown = true"
                    style="width: 100%; padding: 12px 12px 12px 42px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
                </div>

                <!-- 候補リスト -->
                <div x-show="spouseSearchQuery.length > 0 && !showNewSpouseForm"
                  style="margin-top: 8px; max-height: 150px; overflow-y: auto; border: 1px solid #e0ddd8; border-radius: 8px;">
                  <template x-for="member in filteredSpouseCandidates" :key="member.id">
                    <button type="button" @click="selectSpouse(member)"
                      style="width: 100%; padding: 10px 14px; border: none; background: white; text-align: left; border-bottom: 1px solid #f0ede8; cursor: pointer;"
                      onmouseover="this.style.background='#f5f3ef'" onmouseout="this.style.background='white'">
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span x-text="`${member.lastName} ${member.firstName}`"></span>
                        <small style="color: #999;" x-text="`第${member.generation}世代`"></small>
                      </div>
                    </button>
                  </template>
                  <div style="padding: 10px; text-align: center; color: #999;"
                    x-show="filteredSpouseCandidates.length === 0">
                    候補が見つかりません
                  </div>
                </div>

                <small style="color: #999; margin-top: 6px; display: block;"
                  x-show="spouseSearchQuery.length === 0 && !showNewSpouseForm">
                  <i class="bi bi-info-circle"></i> 名前を入力して配偶者を検索してください
                </small>

                <!-- 配偶者を新規登録ボタン -->
                <button type="button" @click="toggleNewSpouseForm()" x-show="!showNewSpouseForm"
                  style="margin-top: 12px; width: 100%; padding: 10px 16px; border: 1px dashed #c0392b; background: rgba(192, 57, 43, 0.05); color: #c0392b; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                  <i class="bi bi-plus-circle"></i> 配偶者を新規登録
                </button>

                <!-- 配偶者新規登録フォーム -->
                <div x-show="showNewSpouseForm" x-transition
                  style="margin-top: 12px; padding: 16px; background: white; border: 1px solid #c0392b; border-radius: 12px;">
                  <div style="font-size: 0.9rem; color: #c0392b; margin-bottom: 12px; font-weight: 500;">
                    <i class="bi bi-heart-fill"></i> 配偶者を新規登録
                  </div>

                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div>
                      <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 4px;">姓</label>
                      <input type="text" x-model="newSpouseForEdit.lastName" :placeholder="editMember?.lastName || '山田'"
                        style="width: 100%; padding: 10px 12px; border: 1px solid #e0ddd8; border-radius: 6px; font-size: 0.95rem; background: #FDFBF7;">
                    </div>
                    <div>
                      <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 4px;">
                        名 <span style="color: #c0392b;">*</span>
                      </label>
                      <input type="text" x-model="newSpouseForEdit.firstName" placeholder="花子"
                        style="width: 100%; padding: 10px 12px; border: 1px solid #e0ddd8; border-radius: 6px; font-size: 0.95rem; background: #FDFBF7;">
                    </div>
                  </div>

                  <div style="margin-bottom: 12px;">
                    <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 4px;">
                      <i class="bi bi-translate" style="color: #2D4A6F;"></i> ローマ字表記
                    </label>
                    <input type="text" x-model="newSpouseForEdit.romanizedName" placeholder="Hanako Yamada"
                      @blur="newSpouseForEdit.romanizedName = formatRomanizedName(newSpouseForEdit.romanizedName)"
                      style="width: 100%; padding: 10px 12px; border: 1px solid #e0ddd8; border-radius: 6px; font-size: 0.95rem; background: #FDFBF7; font-style: italic;">
                  </div>

                  <div style="margin-bottom: 12px;">
                    <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 4px;">生年月日</label>
                    <input type="text" x-model="newSpouseForEdit.birthDate" placeholder="19900101" inputmode="numeric"
                      @blur="newSpouseForEdit.birthDate = formatDateInput(newSpouseForEdit.birthDate)"
                      style="width: 100%; padding: 10px 12px; border: 1px solid #e0ddd8; border-radius: 6px; font-size: 0.95rem; background: #FDFBF7;">
                  </div>

                  <div style="margin-bottom: 12px;">
                    <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 6px;">登録区分</label>
                    <div style="display: flex; gap: 8px;">
                      <label @click="newSpouseForEdit.registry = 'magomago'"
                        style="flex: 1; padding: 8px 10px; border-radius: 6px; cursor: pointer; text-align: center; font-size: 0.85rem;"
                        :style="newSpouseForEdit.registry === 'magomago' 
                          ? { background: '#4a5d23', color: 'white', border: '1px solid #4a5d23' } 
                          : { background: '#FDFBF7', color: '#666', border: '1px solid #e0ddd8' }">
                        まごまご会
                      </label>
                      <label @click="newSpouseForEdit.registry = 'tengoku'"
                        style="flex: 1; padding: 8px 10px; border-radius: 6px; cursor: pointer; text-align: center; font-size: 0.85rem;"
                        :style="newSpouseForEdit.registry === 'tengoku' 
                          ? { background: '#8B8B8B', color: 'white', border: '1px solid #8B8B8B' } 
                          : { background: '#FDFBF7', color: '#666', border: '1px solid #e0ddd8' }">
                        🕊️ 天国会
                      </label>
                    </div>
                  </div>

                  <div x-show="newSpouseForEdit.registry === 'tengoku'" x-transition style="margin-bottom: 12px;">
                    <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 4px;">入会日（永眠日）</label>
                    <input type="text" x-model="newSpouseForEdit.passedAt" placeholder="20200101" inputmode="numeric"
                      @blur="newSpouseForEdit.passedAt = formatDateInput(newSpouseForEdit.passedAt)"
                      style="width: 100%; padding: 10px 12px; border: 1px solid #e0ddd8; border-radius: 6px; font-size: 0.95rem; background: #FDFBF7;">
                  </div>

                  <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button type="button" @click="showNewSpouseForm = false"
                      style="padding: 8px 16px; border: 1px solid #d0cdc8; background: white; color: #666; border-radius: 20px; font-size: 0.85rem; cursor: pointer;">
                      キャンセル
                    </button>
                    <button type="button" @click="saveNewSpouseFromEdit()"
                      style="padding: 8px 16px; background: #c0392b; color: white; border: none; border-radius: 20px; font-size: 0.85rem; cursor: pointer;">
                      <i class="bi bi-check-lg"></i> 登録
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- 区切り線 -->
            <div style="height: 1px; background: #e0ddd8; margin: 0 0 16px;"></div>

            <!-- 連絡先情報 -->
            <div style="font-family: 'Noto Serif JP', serif; font-size: 0.95rem; color: #2F353B; margin-bottom: 12px;">
              <i class="bi bi-telephone" style="color: #2D4A6F;"></i> 連絡先情報
            </div>

            <div style="margin-bottom: 12px;">
              <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">電話番号</label>
              <input type="tel" x-model="editMember.phone" placeholder="090-1234-5678"
                style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7;">
            </div>

            <div style="margin-bottom: 8px;">
              <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 4px;">住所</label>
              <textarea x-model="editMember.address" placeholder="東京都渋谷区..." rows="2"
                style="width: 100%; padding: 12px 16px; border: 1px solid #e0ddd8; border-radius: 8px; font-size: 1rem; background: #FDFBF7; resize: vertical;"></textarea>
            </div>
          </div>

          <!-- フッター -->
          <div class="modal-footer border-0 pb-4"
            style="background: transparent; display: flex; justify-content: space-between; padding: 0 24px;">
            <button type="button" @click="deleteMember()"
              style="padding: 10px 20px; border: 1px solid #c0392b; background: white; color: #c0392b; border-radius: 24px; font-size: 0.9rem; cursor: pointer;">
              <i class="bi bi-trash"></i> 削除
            </button>
            <div style="display: flex; gap: 12px;">
              <button type="button" @click="cancelEdit()"
                style="padding: 10px 24px; border: 1px solid #d0cdc8; background: white; color: #666; border-radius: 24px; font-size: 0.9rem; cursor: pointer;">
                キャンセル
              </button>
              <button type="button" @click="saveEdit()"
                style="padding: 10px 24px; background: #2D4A6F; color: white; border: none; border-radius: 24px; font-size: 0.9rem; cursor: pointer;">
                <i class="bi bi-check-lg me-1"></i> 更新する
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ======================================== -->
    <!-- 削除確認モーダル -->
    <!-- ======================================== -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> 削除の確認</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="text-center mb-3">
              <i class="bi bi-person-x text-danger" style="font-size: 3rem;"></i>
            </div>
            <p class="text-center mb-3" x-text="deleteConfirmMessage"></p>

            <!-- 配偶者同時削除オプション -->
            <div x-show="deleteSpouseOption" class="alert alert-warning">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="deleteSpouseCheck" x-model="deleteSpouseTogether">
                <label class="form-check-label" for="deleteSpouseCheck">
                  <i class="bi bi-heart-fill text-danger"></i>
                  配偶者「<span x-text="deleteSpouseName"></span>」も一緒に削除する
                </label>
              </div>
            </div>

            <div class="alert alert-secondary mb-0">
              <small><i class="bi bi-info-circle"></i> この操作は取り消せません。</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="bi bi-x-lg"></i> キャンセル
            </button>
            <button type="button" class="btn btn-danger" @click="executeDelete()">
              <i class="bi bi-trash"></i> 削除する
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ======================================== -->
    <!-- 成功通知モーダル -->
    <!-- ======================================== -->
    <div class="modal fade" id="successModal" tabindex="-1">
      <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center py-4">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
            <h5 class="mt-3" x-text="successMessage || '完了しました！'"></h5>
          </div>
          <div class="modal-footer justify-content-center border-0 pt-0">
            <button type="button" class="btn btn-success" data-bs-dismiss="modal">
              OK
            </button>
          </div>
        </div>
      </div>
    </div>

  </div> <!-- /isAuthenticated -->

  <!-- ======================================== -->
  <!-- 更新通知バナー -->
  <!-- ======================================== -->
  <div id="updateBanner"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 16px; text-align: center; z-index: 9999; cursor: pointer;"
    onclick="applyUpdate()">
    <i class="bi bi-arrow-clockwise me-2"></i>新しいバージョンがあります。タップして更新
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App Entry Point -->
  <script type="module" src="/src/main.js"></script>

  <!-- ============================================
       バージョン管理 & 自動更新スクリプト
       ============================================ -->
  <script>
    // ============================================
    // アプリバージョン（version.jsonと同期）
    // ============================================
    const APP_VERSION = '1.0.5';

    // ============================================
    // 更新を適用する関数（バナータップ時に呼ばれる）
    // ============================================
    function applyUpdate() {
      location.reload(true);
    }

    // ============================================
    // 更新バナーを表示
    // ============================================
    function showUpdateBanner() {
      const banner = document.getElementById('updateBanner');
      if (banner) {
        banner.style.display = 'block';
      }
    }

    // ============================================
    // バージョンチェック機能（確実な自動更新）
    // ============================================
    async function checkAppVersion() {
      try {
        // キャッシュを無効にしてversion.jsonを取得
        const response = await fetch('/version.json?t=' + Date.now(), {
          cache: 'no-store',
          headers: { 'Cache-Control': 'no-cache' }
        });

        if (!response.ok) {
          console.log('[Version] version.json取得失敗:', response.status);
          return;
        }

        const data = await response.json();
        const serverVersion = data.version;

        console.log('[Version] サーバー:', serverVersion, 'ローカル:', APP_VERSION);

        // バージョンが異なる場合は自動リロード
        if (serverVersion && serverVersion !== APP_VERSION) {
          console.log('[Version] 新しいバージョンを検出！自動更新します...');

          // キャッシュをクリア
          if ('caches' in window) {
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map(name => caches.delete(name)));
            console.log('[Version] キャッシュクリア完了');
          }

          // ページをリロード（キャッシュ無効）
          window.location.reload(true);
        }
      } catch (error) {
        console.log('[Version] チェック失敗（オフライン?）:', error.message);
      }
    }

    // 起動時にバージョンチェック（少し遅延させてUI表示後に実行）
    document.addEventListener('DOMContentLoaded', () => {
      // バージョン表示を更新
      const versionEl = document.getElementById('appVersionDisplay');
      if (versionEl) {
        versionEl.textContent = 'バージョン v' + APP_VERSION;
      }

      setTimeout(checkAppVersion, 1000);
    });
  </script>
</body>

</html>